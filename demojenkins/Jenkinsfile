pipeline {
    agent any

    environment {
        COMMAND = "curl -X POST -H 'Content-type: application/json' --data"

        API_A = 'https://hooks.slack.com/services/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'
        
        DATE = sh(returnStdout: true, script: "date +'%d-%m-%y'")

        NOTIFICATION_SUCCESS = "'{\"text\":\"NAM == SUCCESS, ${DATE}\"}'"
        NOTIFICATION_FAILTURE = "'{\"text\":\"NAM == FAILTURE, ${DATE}\"}'"       
    }

    parameters {
        //choice(choices: 'staging\nproduction', description: 'Which environment?', name: 'ENVIRONMENT')

        string(name: 'MAJOR_VERSION', defaultValue: '', description: 'Enter major version tag: ')
        string(name: 'MINOR_VERSION', defaultValue: '', description: 'Enter minor version tag: ')
    }

    stages {
        stage ("Begin") {
            steps {
                sh "apt install maven"
            }
        }

        stage ("Build") {
            steps {
                //sh 'mvn -f demojenkins/pom.xml clean package'
                echo "Build ...."
            }
        }

        stage ("Test") {
            steps {
                //step([$class: 'JUnitResultArchiver', testResults: '**/target/surefire-reports/TEST-*.xml'])
                echo "Test ...."
            }
        }

        stage ("Deloy") {
            steps {
                echo "Deloy ...."
            }
        }
    }

    post {
        success {
            sh "${COMMAND} ${NOTIFICATION_SUCCESS} ${API_A}"

            echo "Version: ===== v${params.MAJOR_VERSION}.${params.MINOR_VERSION}"

            sh "cd /root/.jenkins/workspace/java-full-pipeline git tag v${params.MAJOR_VERSION}.${params.MINOR_VERSION}"
            sh "cd /root/.jenkins/workspace/java-full-pipeline && git push origin v${params.MAJOR_VERSION}.${params.MINOR_VERSION}"
        }

        failure {
            sh "${COMMAND} ${NOTIFICATION_FAILTURE} ${API_A}"
        }
    }
}




// stage deloy QA
// - copy file jar to VM 2 
// - excute command as jenkins file 
// note: Tao con VM 2, deloy len con VM 2
